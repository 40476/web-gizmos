<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="img/amogus.png">
    <title>Mega Miner Online - Mobile & Warfare Update</title>
    <!-- MQTT.js Library -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* CSS Reset & Normalization */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; touch-action: none; }

        :root {
            --bg-color: #0d0d0d;
            --panel-bg: rgba(20, 25, 40, 0.95);
            --text-color: #eee;
            --accent: #2980b9;
            --highlight: #f39c12;
            --danger: #c0392b;
            --success: #27ae60;
            --control-height: 180px; /* Reserved space for mobile controls */
        }
        body { overflow:hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, monospace; color: var(--text-color); user-select: none; background: #000; }

        /* Canvas resizing handled by JS, but default to full */
        canvas { display: block; width: 100vw; height: 100vh; }

        .noaliasing {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }

        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }

        /* Mobile Controls Container */
        #mobile-controls {
            display: none; /* Hidden by default */
            z-index: 150;
        }

        /* --- MOBILE MODE LAYOUTS --- */

        /* Portrait: Controls at bottom, Canvas shorter */
        @media (orientation: portrait) {
            body #gear-btn{

            }
            body.mobile-mode #mobile-controls {
                position: fixed; bottom: 0; left: 0; width: 100%; height: var(--control-height);
                background: #111; border-top: 2px solid #333;
                display: flex; justify-content: space-between; align-items: center;
                padding: 10px 20px; pointer-events: auto;
            }
            body.mobile-mode canvas { height: calc(100vh - var(--control-height)); width: 100vw; }
            body.mobile-mode #chat-container { bottom: calc(var(--control-height) + 20px); }
        }

        /* Landscape: Controls on sides, Canvas narrower in middle */
        /* Landscape: Controls on sides, Canvas narrower in middle */
        @media (orientation: landscape) {
            body #gear-btn{

            }
            body.mobile-mode #mobile-controls {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: transparent; pointer-events: none;
                display: flex; justify-content: space-between; align-items: flex-end;
                padding: 20px;
            }

            body.mobile-mode .d-pad, body.mobile-mode .action-pad {
                pointer-events: auto;
                background: rgba(20, 20, 20, 0.8);
                border: 1px solid #444;
                border-radius: 16px;
                padding: 15px;
                margin-bottom: 20px;
                backdrop-filter: blur(4px);
            }

            /* Shift Game Canvas to center, avoiding overlap */
            body.mobile-mode #gameCanvas {
                position: absolute; top: 0; left: 200px;
                width: calc(100vw - 400px); /* 200px buffer each side */
                height: 100vh;
            }

            /* Update: Chat in Left Panel for Mobile Landscape */
            body.mobile-mode #chat-container {
                left: 10px;
                bottom: 220px; /* Above the D-Pad */
                width: 180px;  /* Fit in the 200px sidebar */
                height: 120px;
            }
        }

        /* D-PAD */
        .d-pad {
            width: 150px;
            height: 150px;
            position: relative;
        }
        .d-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: #aaa;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
        }
        .d-btn:active { background: var(--accent); color: white; }
        .d-up { top: 0; left: 50px; }
        .d-down { bottom: 0; left: 50px; }
        .d-left { top: 50px; left: 0; }
        .d-right { top: 50px; right: 0; }

        /* Action Buttons */
        .action-pad {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 160px;
        }
        .act-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .act-btn:active { background: var(--highlight); color: black; transform: scale(0.95); }
        .act-btn i { font-size: 16px; margin-bottom: 2px; font-style: normal;}

        /* Gear Icon */
        #gear-btn { position: absolute; top: 10px; left: 10px; font-size: 30px; color: rgba(255,255,255,0.5); cursor: pointer; pointer-events: auto; z-index: 50; transition: all 0.3s; }
        #gear-btn:hover { color: #fff; transform: rotate(90deg); }

        /* Coords Display */
        #coords-display { position: absolute; top: 10px; left: 60px; font-size: 14px; color: #aaa; font-family: monospace; display: none; text-shadow: 1px 1px 0 #000; }

        /* Mobile specific coords adjustment */
        body.mobile-mode #coords-display { top: 40px; left: 10px; }

        /* Overheat Overlay */
        #heat-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; box-shadow: inset 0 0 0px var(--danger); transition: box-shadow 0.2s; opacity: 0; }

        /* Connection Screens */
        #connection-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        #connection-log { font-family: monospace; color: var(--success); margin-top: 20px; font-size: 14px; text-align: left; width: 300px; height: 100px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: #000; }
        .log-line { margin: 2px 0; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--highlight); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Connection Lost Overlay */
        #disconnect-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 32px; font-weight: bold; background: rgba(0,0,0,0.8); padding: 20px; border: 2px solid var(--danger); display: none; z-index: 200; text-align: center; }

        /* Chat */
        #chat-container { position: absolute; bottom: 120px; left: 10px; width: 300px; height: 150px; display: flex; flex-direction: column; pointer-events: auto; opacity: 0.8; transition: opacity 0.3s; z-index: 10; }
        #chat-container:hover { opacity: 1; }
        #chat-messages { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.6); padding: 5px; font-size: 12px; scrollbar-width: thin; text-shadow: 1px 1px 0 #000; border: 1px solid #444; }
        #chat-input { background: rgba(0,0,0,0.8); border: 1px solid #444; color: white; padding: 5px; width: 100%; box-sizing: border-box; }

        /* Minimap */
        #minimap-container { position: absolute; top: 10px; right: 10px; width: 150px; height: 150px; border: 2px solid #555; background: #000; z-index: 20; overflow: hidden; }
        #minimap { display: block; width: 100%; height: 100%; }

        /* Interaction Prompts */
        #prompt-msg { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); color: var(--highlight); font-size: 20px; font-weight: bold; text-shadow: 0 2px 4px #000; display: none; pointer-events: none; text-align: center; }

        /* Modals */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel-bg); padding: 20px; border: 2px solid var(--accent); border-radius: 8px; width: 600px; max-height: 85vh; overflow-y: auto; pointer-events: auto; z-index: 100; box-shadow: 0 0 30px rgba(0,0,0,0.9); }
        .modal.active { display: block; }
        .modal h2 { margin-top: 0; color: var(--highlight); border-bottom: 1px solid #444; padding-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #aaa; text-transform: uppercase; }
        .form-group input[type="text"], .form-group select { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: white; box-sizing: border-box; }
        .form-group input:disabled { opacity: 0.5; cursor: not-allowed; }
        input[type=range] { width: 100%; accent-color: var(--accent); }

        /* Shop Grid */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .shop-item { background: rgba(0,0,0,0.3); padding: 10px; border: 1px solid #444; display: flex; flex-direction: column; justify-content: space-between; }
        .shop-item h4 { margin: 0 0 5px 0; color: var(--accent); }
        .shop-item p { font-size: 12px; color: #ccc; margin: 0 0 5px 0; }
        .shop-item .cost { color: var(--highlight); font-weight: bold; font-size: 14px; }

        /* Sell List */
        .sell-list { max-height: 150px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #444; background: #111; }
        .sell-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; border-bottom: 1px solid #333; font-size: 12px; }
        .sell-row:last-child { border-bottom: none; }
        .sell-actions button { margin-left: 5px; padding: 2px 8px; font-size: 10px; }

        /* Dashboard (Stats/Inventory) */
        .dash-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 5px; max-height: 200px; overflow-y: auto; }
        .inv-item { background: #222; border: 1px solid #444; padding: 5px; text-align: center; cursor: pointer; font-size: 10px; position: relative; transition: all 0.2s; pointer-events: auto; }
        .inv-item:hover { border-color: #fff; background: #333; }
        .inv-item.active { border-color: gold; box-shadow: 0 0 8px gold; background: rgba(255, 215, 0, 0.1); transform: scale(1.05); z-index: 10; }
        .inv-count { position: absolute; bottom: 2px; right: 2px; font-weight: bold; color: #fff; }
        .inv-trash { position: absolute; top: 0; right: 0; background: #c0392b; color: white; width: 15px; height: 15px; font-size: 10px; line-height: 15px; display: none; cursor: pointer; }
        .inv-trash:hover { filter: brightness(1.2); }
        .inv-item:hover .inv-trash { display: block; }

        .inv-use-btn {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background: var(--success); color: white;
            font-size: 9px; font-weight: bold;
            border: none; cursor: pointer;
            z-index: 20;
        }

        .stat-row { display: flex; justify-content: space-between; font-size: 12px; border-bottom: 1px solid #333; padding: 2px 0; }

        .btn { background: var(--accent); color: white; border: none; padding: 10px; cursor: pointer; transition: all 0.2s; width: 100%; margin-top: 5px; font-weight: bold; border-radius: 4px; }
        .btn:hover { background: #3498db; filter: brightness(1.2); }
        .btn:disabled { background: #555; cursor: not-allowed; filter: none; }
        .btn-small { width: auto; padding: 4px 8px; font-size: 12px; margin-right: 5px; }
        .btn-danger { background: var(--danger); }
        .btn-bind { background: #444; border: 1px solid #666; color: #fff; text-align: left; position: relative; }
        .btn-bind.binding { background: #c0392b; border-color: #e74c3c; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Credits Modal */
        #credits-modal .credits-section { margin-bottom: 25px; }
        #credits-modal h3 { margin: 10px 0; color: var(--accent); font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .credit-entry { margin-left: 15px; margin-top: 8px; }
        .credit-entry strong { color: var(--highlight); font-size: 14px; }
        .credit-entry ul { margin: 5px 0 10px 20px; padding: 0; }
        .credit-entry li { list-style: none; font-size: 12px; color: #ccc; margin: 2px 0; }

        /* Server Status */
        .server-option { display: flex; justify-content: space-between; font-size: 12px; padding: 2px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: #555; margin-right: 5px; }
        .status-dot.green { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-dot.red { background: #e74c3c; }

        /* Save Slots */
        .save-list-wrapper { max-height: 200px; overflow-y: auto; border: 1px solid #444; background: #111; padding: 5px; margin-bottom: 10px; }
        .save-slot { background: rgba(0,0,0,0.4); padding: 8px; border: 1px solid #555; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .save-slot:hover { background: rgba(255,255,255,0.05); }
        .save-slot.active { border-color: var(--highlight); box-shadow: inset 0 0 10px rgba(243, 156, 18, 0.2); }
        .save-slot-info { font-size: 12px; color: #ccc; flex: 1; }
        .save-slot-actions { display:flex; gap: 5px; }
        .save-slot-actions button { margin: 0; padding: 4px 8px; font-size: 10px; }

        /* Start Screen */
        #start-screen { position: absolute;
          background-image:
            linear-gradient(30deg, #683131 12%, transparent 12.5%, transparent 87%, #683131 87.5%, #683131),
            linear-gradient(150deg, #683131 12%, transparent 12.5%, transparent 87%, #683131 87.5%, #683131),
            linear-gradient(30deg, #683131 12%, transparent 12.5%, transparent 87%, #683131 87.5%, #683131),
            linear-gradient(150deg, #683131 12%, transparent 12.5%, transparent 87%, #683131 87.5%, #683131),
            linear-gradient(60deg, #68313180 25%, transparent 25.5%, transparent 75%, #68313180 75%, #68313180),
            linear-gradient(60deg, #68313180 25%, transparent 25.5%, transparent 75%, #68313180 75%, #68313180);
        	background-size: 20px 35px;
          background-position: 0 0, 0 0, 10px 17.5px, 10px 17.5px, 0 0, 10px 17.5px;
          background-color: #362520;
          top: 0; left: 0; width: 100%; height: 100%;
          display: flex; flex-direction: column; align-items: center; justify-content: center;
          z-index: 50; pointer-events: auto;
        }
        #start-screen h1 { font-size: 48px; color: var(--highlight); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 4px; text-shadow: 0 0 10px var(--highlight); }

        .start-container { display:flex; gap:20px; background:rgba(20, 25, 40, 0.95); padding:20px; border-radius:10px; border:1px solid #444; max-width: 800px; max-height: 90vh; overflow-y:auto; }
        .start-panel { width:300px; }
        .server-panel { width:300px; border-left:1px solid #444; padding-left:20px; display:flex; flex-direction:column; }

        @media (max-width: 700px) {
            .start-container { flex-direction: column; }
            .server-panel { border-left: none; border-top: 1px solid #444; padding-left: 0; padding-top: 20px; }
        }

        /* Server List Styles */
        .server-list-item { background:rgba(0,0,0,0.3); padding:8px; margin-bottom:5px; border:1px solid #333; font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; transition:0.2s; }
        .server-list-item:hover { background:rgba(255,255,255,0.05); }
        .server-list-item.active { border-color:var(--highlight); box-shadow:inset 0 0 5px rgba(243, 156, 18, 0.2); }
        .server-status-icon { width:12px; height:12px; margin-right:8px; display:flex; align-items:center; justify-content:center; }
        .spin-loader { border: 2px solid #555; border-top: 2px solid #fff; border-radius: 50%; width: 10px; height: 10px; animation: spin 1s linear infinite; }
        .server-actions { display: flex; gap: 4px; opacity: 0.6; transition: opacity 0.2s; }
        .server-list-item:hover .server-actions { opacity: 1; }

        /* Notification/Error Popup */
        #notification-area { position: absolute; top: 20px; right: 180px; width: 300px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; z-index: 200; }
        .toast { background: rgba(30, 30, 30, 0.95); border-left: 4px solid var(--accent); padding: 12px; color: white; pointer-events: auto; animation: slideIn 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 14px; }
        .toast.error { border-left-color: var(--danger); }
        .toast.warn { border-left-color: var(--highlight); }
        .toast.success { border-left-color: var(--success); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Admin Panel */
        #admin-panel { position: absolute; top: 165px; right: 10px; background: rgba(0,0,0,0.7); padding: 10px; display: none; pointer-events: auto; width: 150px; border: 1px solid #555; }
        .player-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 11px; }

        /* --- FIXES --- */

        /* 1. Mobile Toast Fix: prevent off-screen width causing overflow/glitches */
        @media (max-width: 600px) {
            #notification-area {
                right: 10px;
                left: 10px;
                width: auto;
                top: 60px;
            }
        }

        /* 2. Scroll Fix: Re-enable scrolling on containers that need it */
        .start-container,
        .modal,
        #server-list-sidebar,
        .sell-list,
        .inv-grid,
        #chat-messages,
        #connection-log,
        #save-list-wrapper,
        .save-list-wrapper {
            touch-action: pan-y !important;
        }

        /* 3. Animation Fix: Use Vertical slide instead of Horizontal to prevent layout thrashing */
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Warp List */
        .warp-list { max-height: 250px; overflow-y: auto; background: #111; border: 1px solid #444; }
        .warp-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; cursor: pointer; align-items: center; }
        .warp-item:hover { background: #222; }
        .warp-item:last-child { border-bottom: none; }
        .warp-coords { color: #888; font-size: 12px; font-family: monospace; margin-left: 10px; }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="mobile-controls">
        <div class="d-pad">
            <div class="d-btn d-up" data-key="up">&#8593;</div>
            <div class="d-btn d-left" data-key="left">&#8592;</div>
            <div class="d-btn d-right" data-key="right">&#8594;</div>
            <div class="d-btn d-down" data-key="down">&#8595;</div>
        </div>
        <div class="action-pad">
            <div class="act-btn" data-key="build" style="background:var(--highlight); color:black;"><i>B</i>BUILD</div>
            <div class="act-btn" data-key="interact" style="background:var(--success);"><i>E</i>MENU</div>
            <div class="act-btn" data-key="chat" style="background:#555;"><i>&#9166;</i>CHAT</div>
            <div class="act-btn" data-key="transfer" style="background:#8e44ad;"><i>F</i>GIVE</div>
        </div>
    </div>

    <div id="ui-layer">
        <div id="heat-overlay"></div>

        <!-- Gear Icon -->
        <div id="gear-btn" onclick="UI.openSettings()">&#9881;</div>

        <!-- Coords -->
        <div id="coords-display">X: 0 Y: 0</div>

        <!-- Connection Lost -->
        <div id="disconnect-msg">CONNECTION LOST<br><span style="font-size:16px; font-weight:normal; color:#fff;">Trying to reconnect...</span></div>

        <!-- Connection Screen -->
        <div id="connection-screen">
            <div class="spinner"></div>
            <h2 style="color:#fff; margin-top:20px;">ESTABLISHING UPLINK</h2>
            <div id="connection-log"></div>
        </div>

        <!-- Minimap -->
        <div id="minimap-container">
            <canvas id="minimap" class="noaliasing"></canvas>
        </div>

        <!-- Chat -->
        <div id="chat-container">
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Press CHAT key to type...">
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel">
            <h4 style="margin:0 0 10px 0; color:gold; font-size:12px;">Host Controls</h4>
            <div id="player-list"></div>
        </div>

        <!-- Prompt -->
        <div id="prompt-msg"></div>

        <!-- Start Screen -->
        <div id="start-screen">
            <h1>Mega Miner</h1>
            <div class="start-container">
                <div class="start-panel">
                    <div class="form-group">
                        <label>Username</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="start-username" placeholder="Enter Username" maxlength="12" style="flex:1;">
                            <button class="btn btn-small" style="width:auto; padding: 0 10px; font-size: 16px;" onclick="Game.randomizeUsername()" title="Randomize Username">&#127922;</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Room ID</label>
                        <input type="text" id="start-room" value="public-mine-1">
                    </div>
                    <div class="form-group">
                        <label>Vehicle Color</label>
                        <input type="color" id="start-color" value="#3498db" style="height:40px;">
                    </div>
                    <div class="form-group">
                        <label style="display:inline-flex; align-items:center;">
                            <input type="checkbox" id="mobile-toggle" onchange="Game.toggleMobile(this.checked)"> Enable Mobile Controls
                        </label>
                    </div>
                    <button class="btn" onclick="Game.init()">LAUNCH MISSION</button>
                    <button class="btn" style="margin-top:10px; background:#444;" onclick="UI.openSettings()">SETTINGS / IMPORT</button>
                </div>

                <div class="server-panel">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <label style="margin:0; font-size:12px; color:#aaa;">SERVER STATUS</label>
                        <button class="btn btn-small" style="width:auto; padding:2px 5px;" onclick="UI.refreshServerList()">&#8635;</button>
                    </div>
                    <div id="server-list-sidebar" style="flex:1; overflow-y:auto; max-height:200px; margin-bottom:10px;">
                        <!-- Injected via JS -->
                    </div>

                    <div class="form-group" style="margin-bottom:0;">
                        <label>Add Custom Server</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="custom-server-input" placeholder="wss://..." style="font-size:11px;">
                            <button class="btn btn-small" style="width:auto;" onclick="UI.addCustomServer()">+</button>
                        </div>
                    </div>
                    <div style="margin-top:10px; font-size:10px; color:#e74c3c; line-height:1.4; background:rgba(231, 76, 60, 0.1); padding:5px; border:1px solid #e74c3c;">
                        <strong>WARNING:</strong> You must select the SAME server as your friends to see them. Check status before joining.
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Modal (Inventory/Stats) -->
        <div id="dashboard-modal" class="modal">
            <h2>Pilot Dashboard</h2>
            <div class="dash-cols">
                <div>
                    <h4 style="color:#aaa; border-bottom:1px solid #444;">INVENTORY / BUILD</h4>
                    <p style="font-size:11px; color:#777;">Click item to Equip. Consumables have a [USE] button. Hover to Trash.</p>
                    <button class="btn btn-small" style="background:#c0392b; width:100%; margin-bottom:10px;" onclick="Game.trashJunk()">TRASH ALL JUNK (Dirt/Stone)</button>
                    <div id="inv-grid" class="inv-grid"></div>
                    <div id="station-btn-container" style="margin-top:20px; display:none;">
                        <button class="btn" style="background:var(--success);" onclick="Shop.open()">OPEN STATION SHOP</button>
                    </div>
                </div>
                <div>
                    <h4 style="color:#aaa; border-bottom:1px solid #444;">STATISTICS</h4>
                    <div id="stats-container"></div>

                    <h4 style="color:#aaa; border-bottom:1px solid #444; margin-top:20px;">LEADERBOARD (Local)</h4>
                    <div id="leaderboard-container"></div>
                </div>
            </div>
            <button class="btn" style="background:#555; margin-top:20px;" onclick="$('dashboard-modal').classList.remove('active')">Close</button>
        </div>

        <!-- Warp Modal -->
        <div id="warp-modal" class="modal">
            <h2>Teleporter Network</h2>
            <p style="font-size:12px; color:#ccc;">Select a destination. Discovered relays appear here automatically.</p>
            <div id="warp-list" class="warp-list"></div>
            <button class="btn" style="background:#555; margin-top:20px;" onclick="$('warp-modal').classList.remove('active')">Cancel</button>
        </div>

        <!-- Shop Modal -->
        <div id="shop-modal" class="modal">
            <h2>Service Station</h2>
            <div style="text-align:center; margin-bottom:15px; font-size:18px;">
                Wallet: <span id="shop-money" style="color:gold; font-weight:bold;">$0</span>
            </div>
            <button class="btn" style="margin-bottom:10px; background:var(--success);" onclick="Shop.sellAll()">SELL ALL ORES</button>
            <button class="btn" style="margin-bottom:10px; background:var(--success);" onclick="Shop.refuelRepair()">Refuel and Repair ($10)</button>

            <h4 style="color:#aaa; border-bottom:1px solid #444;">SELL MINERALS</h4>
            <div id="sell-list" class="sell-list"></div>

            <h4 style="color:#aaa; border-bottom:1px solid #444; margin-top:20px;">UPGRADES & SUPPLIES</h4>
            <div class="shop-grid">
                <!-- Upgrades -->
                <div class="shop-item">
                    <h4>Upgrade Drill</h4>
                    <p>Increases Mining Tier.</p>
                    <div class="cost" id="cost-drill"></div>
                    <button class="btn" id="btn-drill" onclick="Shop.buy('drill')">Upgrade</button>
                </div>
                <div class="shop-item">
                    <h4>Nanite Hull</h4>
                    <p>Increases Max HP.</p>
                    <div class="cost" id="cost-hull"></div>
                    <button class="btn" id="btn-hull" onclick="Shop.buy('hull')">Upgrade</button>
                </div>
                <div class="shop-item">
                    <h4>Fuel Compactor</h4>
                    <p>Increases Fuel Capacity.</p>
                    <div class="cost" id="cost-fuel"></div>
                    <button class="btn" id="btn-fuel" onclick="Shop.buy('fuel')">Upgrade</button>
                </div>
                <div class="shop-item">
                    <h4>Cargo Bay</h4>
                    <p>Increases Carrying Capacity.</p>
                    <div class="cost" id="cost-cargo"></div>
                    <button class="btn" id="btn-cargo" onclick="Shop.buy('cargo')">Upgrade</button>
                </div>
                <div class="shop-item">
                    <h4>Heat Shield</h4>
                    <p>Resist high temperatures.</p>
                    <div class="cost" id="cost-cool"></div>
                    <button class="btn" id="btn-cool" onclick="Shop.buy('cool')">Upgrade</button>
                </div>
                <div class="shop-item">
                    <h4>X-Ray Optics</h4>
                    <p>See minerals through walls.</p>
                    <div class="cost" id="cost-xray"></div>
                    <button class="btn" id="btn-xray" onclick="Shop.buy('xray')">Upgrade</button>
                </div>
                 <div class="shop-item">
                    <h4>Vehicle Paint</h4>
                    <p>Change your look.</p>
                    <input type="color" id="shop-color-picker" style="width:100%; height:30px; margin-bottom:5px;">
                    <button class="btn" onclick="Shop.buy('paint')">Repaint ($100)</button>
                </div>
                <!-- New Items -->
                 <div class="shop-item">
                    <h4>Repair Kit</h4>
                    <p>Restore 50 HP (Use in Inv).</p>
                    <div class="cost">$50</div>
                    <button class="btn" onclick="Shop.buy('repair_kit')">Buy</button>
                </div>
                <div class="shop-item">
                    <h4>Fuel Voucher</h4>
                    <p>Restore 50 Fuel (Use in Inv).</p>
                    <div class="cost">$50</div>
                    <button class="btn" onclick="Shop.buy('fuel_voucher')">Buy</button>
                </div>
                 <div class="shop-item">
                    <h4>TNT</h4>
                    <p>Explosive charge. Range: 3.</p>
                    <div class="cost">$200</div>
                    <button class="btn" onclick="Shop.buy('tnt')">Buy</button>
                </div>
                <div class="shop-item">
                    <h4>Nuke</h4>
                    <p>Massive destruction. Range: 10.</p>
                    <div class="cost" style="color:#c0392b;">$5000</div>
                    <button class="btn btn-danger" onclick="Shop.buy('nuke')">Buy</button>
                </div>
                <div class="shop-item">
                    <h4>Teleporter</h4>
                    <p>Fast travel to surface.</p>
                    <div class="cost">$1000</div>
                    <button class="btn" onclick="Shop.buy('teleporter')">Buy</button>
                </div>
            </div>
            <button class="btn" style="background:#555; margin-top:20px;" onclick="Shop.close()">Exit Station</button>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <h2>Settings</h2>

            <div class="form-group">
                <label>Audio Mixer</label>
                <div style="font-size:12px; display:grid; grid-template-columns: 1fr 3fr 1fr; gap:10px; align-items:center;">
                    <span>Master</span> <input type="range" id="vol-master" min="0" max="1" step="0.01" value="0.5" oninput="Sound.setVolume('master', this.value)"> <span id="vol-disp-master">50%</span>
                    <span>Music</span> <input type="range" id="vol-music" min="0" max="1" step="0.01" value="0.1" oninput="Sound.setVolume('music', this.value)"> <span id="vol-disp-music">50%</span>
                    <span>SFX</span> <input type="range" id="vol-sfx" min="0" max="1" step="0.01" value="0.5" oninput="Sound.setVolume('sfx', this.value)"> <span id="vol-disp-sfx">50%</span>
                    <span>Engine</span> <input type="range" id="vol-engine" min="0" max="1" step="0.01" value="0.5" oninput="Sound.setVolume('engine', this.value)"> <span id="vol-disp-engine">50%</span>
                </div>
            </div>

            <div class="form-group">
                <label>Options</label>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <label style="display:inline-flex; align-items:center; color:#eee;">
                        <input type="checkbox" id="autosave-toggle" checked onchange="SaveSystem.toggleAutosave(this.checked)"> Autosave
                    </label>
                    <label style="display:inline-flex; align-items:center; color:#eee;">
                        <input type="checkbox" id="coords-toggle" onchange="Game.toggleCoords(this.checked)"> Show Coordinates
                    </label>
                     <label style="display:inline-flex; align-items:center; color:#eee;">
                        <input type="checkbox" id="mobile-setting-toggle" onchange="Game.toggleMobile(this.checked)"> Mobile Controls
                    </label>
                    <label style="display:inline-flex; align-items:center; text-transform:none; color:#eee;">
                        <input type="checkbox" id="update-check-toggle" checked> Autocheck Updates (60s)
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Update Checker</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <button class="btn btn-small" style="width:auto;" onclick="UI.checkForUpdates()">Check For Updates</button>
                </div>
                <div id="gh-status" style="font-size:11px; color:#aaa;">Check official repo for updates.</div>
            </div>

            <div class="form-group">
                <label>Active Broker (Set in Start Screen)</label>
                <input type="text" id="setting-broker" placeholder="wss://...t" disabled style="opacity:0.7">
                <small style="color:#777;">Reload to change connection.</small>
            </div>

            <div class="form-group">
                <label>Save Management (IndexedDB)</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <button class="btn" style="flex:1; background:var(--success);" onclick="SaveSystem.createNewSave()">+ NEW SAVE</button>
                    <button class="btn" style="flex:1;" onclick="SaveSystem.saveCurrent()">SAVE CURRENT</button>
                </div>
                <div id="save-list-wrapper" class="save-list-wrapper">
                    <!-- Saves injected here -->
                </div>
                <small style="color:#777;">Saves are unlimited. Green border indicates current session.</small>
            </div>
            <div class="form-group">
                <label>Controls</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:12px;">
                    <button id="btn-bind-up" class="btn btn-bind" onclick="Input.startBind('up')">UP</button>
                    <button id="btn-bind-left" class="btn btn-bind" onclick="Input.startBind('left')">LEFT</button>
                    <button id="btn-bind-down" class="btn btn-bind" onclick="Input.startBind('down')">DOWN</button>
                    <button id="btn-bind-right" class="btn btn-bind" onclick="Input.startBind('right')">RIGHT</button>
                    <button id="btn-bind-build" class="btn btn-bind" onclick="Input.startBind('build')">BUILD</button>
                    <button id="btn-bind-interact" class="btn btn-bind" onclick="Input.startBind('interact')">MENU/INTERACT</button>
                    <button id="btn-bind-transfer" class="btn btn-bind" onclick="Input.startBind('transfer')">TRANSFER</button>
                    <button id="btn-bind-chat" class="btn btn-bind" onclick="Input.startBind('chat')">CHAT</button>
                </div>
                <small>Hold BUILD + Arrow to place Equipped block. Mouse Wheel to Zoom.</small>
            </div>

            <div class="form-group">
                <label>Backup Data (File)</label>
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <button class="btn" style="flex: 1; background:#444;" onclick="$('import-file').click()">Load Save from File</button>
                </div>
                <input type="file" id="import-file" style="margin-top:5px; display:none;" onchange="SaveSystem.importSave(this)">
            </div>
            <div id="credits"></div>
            <button class="btn" onclick="UI.closeSettings()">Close</button>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification-area"></div>
<script>
const $ = id => document.getElementById(id);

// Robust UUID Generator (longer for collision avoidance)
const uuid = () => {
    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
    }
    // Fallback if crypto.randomUUID not available (older browsers/contexts)
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
};

const now = () => Date.now();
const clamp = (num, min, max) => Math.min(Math.max(num, min), max);
const BUILD_TIMESTAMP = Date.now();

// --- SEEDED RNG ---
const pseudoRandom = (x, y) => {
    return Math.abs(Math.sin(x * 12.9898 + y * 78.233) * 43758.5453) % 1;
};

// --- CONFIG & STATE ---
const CONSTANTS = {
    TILE_SIZE: 32, CHUNK_SIZE: 16, SPEED_NORMAL: 1.75, SPEED_DRILL: 0.75,
    FUEL_CONSUMPTION: 0.125, MAP_WIDTH: 1000, MAP_HEIGHT: 2000, MIN_ZOOM: 0.5, MAX_ZOOM: 3.0
};


const TILE_TYPES = {
    EMPTY: 0, DIRT: 1, GRASS: 2, STONE: 3, HARD_STONE: 4, DEEP_SLATE: 5,
    COAL: 6, IRON: 7, GOLD: 8, DIAMOND: 9, EMERALD: 10, RUBY: 11,
    CASING: 20, BEDROCK: 99,
    // New Items
    TNT: 50, NUKE: 51, TELEPORTER: 52,
    REPAIR_KIT: 60, FUEL_VOUCHER: 61
};

const TILE_PROPS = {
    [TILE_TYPES.EMPTY]: { name: "Empty" },
    [TILE_TYPES.DIRT]: { name: "Dirt", color: '#5d4037', hardness: 1, value: 0, tier: 0 },
    [TILE_TYPES.GRASS]: { name: "Grass", color: '#388e3c', hardness: 1, value: 0, tier: 0 },
    [TILE_TYPES.STONE]: { name: "Stone", color: '#7f8c8d', hardness: 3, value: 0, tier: 1 },
    [TILE_TYPES.HARD_STONE]: { name: "Dense Stone", color: '#525a5b', hardness: 6, value: 0, tier: 2 },
    [TILE_TYPES.DEEP_SLATE]: { name: "Deep Slate", color: '#2c3e50', hardness: 10, value: 0, tier: 3 },
    [TILE_TYPES.COAL]: { name: "Coal", color: '#2c3e50', hardness: 2, value: 10, tier: 0 },
    [TILE_TYPES.IRON]: { name: "Iron", color: '#95a5a6', hardness: 4, value: 50, tier: 1 },
    [TILE_TYPES.GOLD]: { name: "Gold", color: '#f1c40f', hardness: 6, value: 150, tier: 2 },
    [TILE_TYPES.DIAMOND]: { name: "Diamond", color: '#3498db', hardness: 10, value: 500, tier: 3 },
    [TILE_TYPES.EMERALD]: { name: "Emerald", color: '#2ecc71', hardness: 12, value: 800, tier: 3 },
    [TILE_TYPES.RUBY]: { name: "Ruby", color: '#e74c3c', hardness: 15, value: 1200, tier: 4 },
    [TILE_TYPES.CASING]: { name: "Structure", color: '#95a5a6', hardness: 2, value: 0, tier: 0 },
    [TILE_TYPES.BEDROCK]: { name: "Bedrock", color: '#000000', hardness: 999, value: 0, tier: 99 },
    // New Items
    [TILE_TYPES.TNT]: { name: "TNT", color: '#e74c3c', hardness: 1, value: 0, tier: 0 },
    [TILE_TYPES.NUKE]: { name: "Nuke", color: '#2c3e50', hardness: 1, value: 0, tier: 0 },
    [TILE_TYPES.TELEPORTER]: { name: "Teleporter", color: '#9b59b6', hardness: 5, value: 0, tier: 0 },
    [TILE_TYPES.REPAIR_KIT]: { name: "Repair Kit", color: '#2ecc71', value: 0, consumable: true },
    [TILE_TYPES.FUEL_VOUCHER]: { name: "Fuel Voucher", color: '#e67e22', value: 0, consumable: true },
};

// Items that should NOT be trashed even if value is 0
const SHOP_ITEMS = [
    TILE_TYPES.TNT,
    TILE_TYPES.NUKE,
    TILE_TYPES.TELEPORTER,
    TILE_TYPES.REPAIR_KIT,
    TILE_TYPES.FUEL_VOUCHER
];

const MSGS = {
    join: [
        "spawned in.",
        "slid into the server.",
        "has entered the chat.",
        "is here to steal your ores.",
        "initialized connection.",
        "mounted their filesystem.",
        "is among us.",
        "has joined! Hide your snacks.",
        "*Record scratch* *Freeze frame* Yup, that's <user>. You're probably wondering how they got here.",
        "A wild <user> appeared!",
        "Everyone panic! <user> has arrived!",
        "<user> has joined. The quality of this room just went up by 0.0001%.",
        "<user> is now watching you. (Just kidding... probably.)"
    ],
    leave: [
        "rage quit.",
        "timed out (RIP).",
        "received SIGTERM.",
        "failed to compile.",
        "segfaulted.",
        "touched grass (Fatal Error).",
        "kernel panicked.",
        "unmounted themselves.",
        "decided to touch grass."
    ],
    kick: [
        "was yeeted.",
        "read the TOS wrong.",
        "was shown the door.",
        "forgot to pay rent."
    ],
    ban: [
        "has been banished to the shadow realm.",
        "caught the ban hammer.",
        "was added to the blacklist.",
        "was banished from this kingdom."
    ],
    death: [
        "forgot to breathe.",
        "became bedrock.",
        "needs a tutorial.",
        "rm -rf /'d themselves.",
        "experienced a stack overflow.",
        "dereferenced a null pointer.",
        "got rekt."
    ],
    rescue: ["is running on fumes!", "needs a fuel stim!", "is signaling SOS!"]
};

let initialTimestamp = null;

// --- SOUND ENGINE ---
class SoundManager {
    constructor() {
        this.ctx = null;
        this.nodes = {};
        this.volumes = { master: 0.5, music: 0.5, sfx: 0.5, engine: 0.3 };
        this.playlist = ['audio/Chiptronical.ogg', 'audio/Great_Little_Challenge.ogg', 'audio/Solve_The_Puzzle.ogg', 'audio/Sneaky_Snitch.mp3', 'audio/cozy-lofi-relax-468509.mp3', 'audio/field-duel-lofi-464436.mp3', 'audio/lofi-background-music-3-471122.mp3','audio/chill-lofi-beat-469069.mp3'];
        this.currentTrack = 0;
        this.noiseBuffer = null;
    }

    init() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.noiseBuffer = this.createNoiseBuffer();
            this.setupNodes();
            this.setupEngineLoop();
            this.playNextMusic();
        } else if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    }

    setupNodes() {
        this.nodes.master = this.ctx.createGain();
        this.nodes.master.gain.value = this.volumes.master;
        this.nodes.master.connect(this.ctx.destination);

        this.nodes.music = this.ctx.createGain();
        this.nodes.music.gain.value = this.volumes.music;
        this.nodes.music.connect(this.nodes.master);

        this.nodes.sfx = this.ctx.createGain();
        this.nodes.sfx.gain.value = this.volumes.sfx;
        this.nodes.sfx.connect(this.nodes.master);

        this.nodes.engine = this.ctx.createGain();
        this.nodes.engine.gain.value = this.volumes.engine;
        this.nodes.engine.connect(this.nodes.master);
    }

    setVolume(type, val) {
        this.volumes[type] = parseFloat(val);
        if (this.nodes[type]) this.nodes[type].gain.setTargetAtTime(this.volumes[type], this.ctx.currentTime, 0.1);
        else if (type === 'master' && this.nodes.master) this.nodes.master.gain.setTargetAtTime(this.volumes[type], this.ctx.currentTime, 0.1);
        $(`vol-disp-${type}`).innerText = Math.round(val*100) + '%';
        localStorage.setItem(`mm_vol_${type}`, val);
    }

    createNoiseBuffer() {
        if (!this.ctx) return null;
        const bufSize = this.ctx.sampleRate * 2;
        const buffer = this.ctx.createBuffer(1, bufSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
        return buffer;
    }

    setupEngineLoop() {
        const noise = this.ctx.createBufferSource();
        noise.buffer = this.noiseBuffer;
        noise.loop = true;
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 100;
        const gain = this.ctx.createGain();
        gain.gain.value = 0;
        noise.connect(filter);
        filter.connect(gain);
        gain.connect(this.nodes.engine);
        noise.start();

        this.nodes.engineRumbleGain = gain;
        this.nodes.engineFilter = filter;

        const grindNoise = this.ctx.createBufferSource();
        grindNoise.buffer = this.noiseBuffer;
        grindNoise.loop = true;
        grindNoise.playbackRate.value = 0.5;

        const grindFilter = this.ctx.createBiquadFilter();
        grindFilter.type = 'bandpass';
        grindFilter.frequency.value = 150;
        grindFilter.Q.value = 1.0;

        const grindGain = this.ctx.createGain();
        grindGain.gain.value = 0;

        grindNoise.connect(grindFilter);
        grindFilter.connect(grindGain);
        grindGain.connect(this.nodes.engine);
        grindNoise.start();

        this.nodes.drillGain = grindGain;
        this.nodes.drillFilter = grindFilter;
    }

    updateEngine(speed, isDrilling) {
        if (!this.ctx || !this.nodes.engineRumbleGain || !this.nodes.engineFilter || !this.nodes.drillGain || !this.nodes.drillFilter) return;

        const t = this.ctx.currentTime;
        let baseVol = (speed > 0.1) ? 0.3 : 0.05;
        let baseFreq = 60 + (speed * 30);

        this.nodes.engineRumbleGain.gain.setTargetAtTime(baseVol, t, 0.2);
        this.nodes.engineFilter.frequency.setTargetAtTime(baseFreq, t, 0.2);

        if (isDrilling) {
            this.nodes.drillGain.gain.setTargetAtTime(0.5, t, 0.05);
            this.nodes.drillFilter.frequency.setTargetAtTime(150 + Math.random()*100, t, 0.1);
        } else {
            this.nodes.drillGain.gain.setTargetAtTime(0, t, 0.1);
        }
    }

    playTone(freq, type, duration, vol = 0.1) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.nodes.sfx);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    }

    playMining() {
        if (!this.ctx || !this.noiseBuffer) return;
        const t = this.ctx.currentTime;

        const src = this.ctx.createBufferSource();
        src.buffer = this.noiseBuffer;
        src.playbackRate.value = 0.4 + Math.random() * 0.2;

        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 500;

        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(0.5, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);

        src.connect(filter);
        filter.connect(gain);
        gain.connect(this.nodes.sfx);
        src.start();
        src.stop(t + 0.15);
    }

    playChat(type) {
        if (type==='join') { this.playTone(440, 'sine', 0.1); setTimeout(()=>this.playTone(880, 'sine', 0.2), 100); }
        else if (type==='leave') { this.playTone(440, 'sine', 0.1); setTimeout(()=>this.playTone(220, 'sine', 0.2), 100); }
        else if (type==='death') { this.playTone(100, 'sawtooth', 0.5, 0.2); }
        else this.playTone(600, 'triangle', 0.05);
    }
    playError() { this.playTone(150, 'sawtooth', 0.3, 0.1); }
    playSuccess() { this.playTone(800, 'sine', 0.1); setTimeout(()=>this.playTone(1200, 'sine', 0.2), 100); }
    playBuild() { this.playTone(300, 'square', 0.1); }
    playThud() { this.playTone(80, 'square', 0.1, 0.3); }

    playNextMusic() {
      try{
        if(this.musicSource) { this.musicSource.stop(); }
        this.currentTrack = Math.floor(Math.random() * 100) % this.playlist.length;
        const file = this.playlist[this.currentTrack];
        const audio = new Audio(file);
        const source = this.ctx.createMediaElementSource(audio);
        source.connect(this.nodes.music);
        audio.onended = () => this.playNextMusic();
        audio.onerror = () => { console.log("Music load failed, skipping"); this.playNextMusic(); };
        audio.play().catch(e=>console.log("Autoplay blocked"));
      }catch(e){
        console.error("Error playing music:", e);
      }
    }

    loadSettings() {
        ['master', 'music', 'sfx', 'engine'].forEach(t => {
            const v = localStorage.getItem(`mm_vol_${t}`);
            if(v !== null) {
                this.volumes[t] = parseFloat(v);
                $(`vol-${t}`).value = v;
                $(`vol-disp-${t}`).innerText = Math.round(v*100) + '%';
            }
        });
    }
}
const Sound = new SoundManager();

// --- GAME LOGIC ---

class GameEngine {
    constructor() {
        this.canvas = $('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.minimapCanvas = $('minimap');
        this.minimapCtx = this.minimapCanvas.getContext('2d');

        this.running = false;
        this.isMobile = false;

        this.settings = {
            username: '',
            color: '#3498db',
            broker: 'wss://broker.emqx.io:8084/mqtt',
            room: 'public',
            keys: {
                up: 'ArrowUp', left: 'ArrowLeft', right: 'ArrowRight', down: 'ArrowDown',
                build: 'b', interact: 'e', chat: 'Enter', transfer: 'f'
            }
        };

        this.localPlayer = {
            id: uuid(),
            gridX: CONSTANTS.MAP_WIDTH/2, gridY: 4,
            x: 0, y: 0,
            fuel: 100, maxFuel: 100,
            hull: 100, maxHull: 100,
            cargo: 0, maxCargo: 50,
            money: 0,
            temp: 0, maxTemp: 100,
            rotation: 0, isDrilling: false,
            drillTier: 0, heatResist: 0, xrayRange: 6,
            inventory: {},
            selectedBlock: TILE_TYPES.CASING,
            stats: { blocksMined: {}, totalMined: 0, startTime: now() },
            joinedAt: now(),
            teleporters: [] // Discovered teleporters list
        };

        this.map = [];
        this.discovered = [];
        this.remotePlayers = {};
        this.camera = { x: 0, y: 0 };
        this.zoom = 1.0;
        this.particles = [];
        this.explosives = []; // Track active TNT/Nuke timers
        this.isAdmin = false;
        this.hostId = null;
        this.bannedIds = JSON.parse(localStorage.getItem('mm_banned') || '[]');
        this.lastActionTime = 0;
        this.lastAutosave = 0;
        this.fallHeight = 0;
        this.stationGridX = CONSTANTS.MAP_WIDTH / 2;
        this.stationGridY = 4;
        this.lastHostHeartbeat = 0;

        this.loadStoredSettings();
    }

    // --- NEW: Persistent Stats (Wallet, Upgrades) ---
    saveLocalProgress() {
        if (!this.running) return;
        const data = {
            money: this.localPlayer.money,
            drillTier: this.localPlayer.drillTier,
            maxHull: this.localPlayer.maxHull,
            maxFuel: this.localPlayer.maxFuel,
            maxCargo: this.localPlayer.maxCargo,
            heatResist: this.localPlayer.heatResist,
            xrayRange: this.localPlayer.xrayRange,
            vehColor: this.settings.color,
            teleporters: this.localPlayer.teleporters || []
        };
        localStorage.setItem(`mm_stats_${this.settings.room}`, JSON.stringify(data));
    }

    loadLocalProgress() {
        try {
            const raw = localStorage.getItem(`mm_stats_${this.settings.room}`);
            if (raw) {
                const data = JSON.parse(raw);
                const p = this.localPlayer;
                if (data.money !== undefined) p.money = data.money;
                if (data.drillTier) p.drillTier = data.drillTier;
                if (data.maxHull) { p.maxHull = data.maxHull; p.hull = p.maxHull; }
                if (data.maxFuel) { p.maxFuel = data.maxFuel; p.fuel = p.maxFuel; }
                if (data.maxCargo) p.maxCargo = data.maxCargo;
                if (data.heatResist) p.heatResist = data.heatResist;
                if (data.xrayRange) p.xrayRange = data.xrayRange;
                if (data.teleporters) p.teleporters = data.teleporters;
                if (data.vehColor) {
                    this.settings.color = data.vehColor;
                    $('start-color').value = data.vehColor;
                }
                console.log("Stats loaded from local storage.");
            }
        } catch(e) { console.error("Failed to load stats", e); }
    }

    // --- NEW: Stable Admin Logic ---
    checkHostHealth() {
        const nowTime = Date.now();

        // If I am Admin, I am the host.
        if (this.isAdmin) {
            this.hostId = this.localPlayer.id;
            this.lastHostHeartbeat = nowTime;
            return;
        }

        // If no host heard for 5 seconds, trigger election
        if (nowTime - this.lastHostHeartbeat > 5000) {
            this.electNewHost();
        }
    }

    electNewHost() {
        // Find oldest player including myself
        const all = Object.values(this.remotePlayers)
            .concat([this.localPlayer])
            .filter(p => p && p.joinedAt);

        // Sort by age
        all.sort((a, b) => a.joinedAt - b.joinedAt);

        // If I am the oldest survivor, I claim the throne
        if (all.length > 0 && all[0].id === this.localPlayer.id) {
            console.log("Host timed out. Claiming Host status.");
            this.isAdmin = true;
            this.hostId = this.localPlayer.id;
            this.lastHostHeartbeat = Date.now();
            Network.broadcastHostClaim(); // Tell everyone immediately
            UI.showToast("You are now the Admin (Host)", "success");
            UI.updateAdminPanel();
        }
    }
    loadStoredSettings() {

        if(localStorage.getItem('mm_username')) $('start-username').value = localStorage.getItem('mm_username');
        if(localStorage.getItem('mm_room_id')) $('start-room').value = localStorage.getItem('mm_room_id');
        if(localStorage.getItem('mm_veh_color')) $('start-color').value = localStorage.getItem('mm_veh_color');
        const showCoords = localStorage.getItem('mm_show_coords');
        if(showCoords === 'true') { $('coords-toggle').checked = true; this.toggleCoords(true); }

        // Load broker from storage or use default if none
        const storedBroker = localStorage.getItem('mm_broker_url');
        if (storedBroker) {
            this.settings.broker = storedBroker;
            $('setting-broker').value = storedBroker;
        } else {
            // Ensure input matches default if nothing stored
            $('setting-broker').value = this.settings.broker;
        }
        const binds = localStorage.getItem('mm_keybinds');
        if(binds) {
            try { this.settings.keys = {...this.settings.keys, ...JSON.parse(binds)}; } catch(e){console.error(e);}
        }

        // Mobile setting
        const mobile = localStorage.getItem('mm_mobile_mode') === 'true';
        $('mobile-toggle').checked = mobile;
        $('mobile-setting-toggle').checked = mobile;
        this.toggleMobile(mobile);
    }

    toggleMobile(enabled) {
        this.isMobile = enabled;
        localStorage.setItem('mm_mobile_mode', enabled);

        if (enabled) {
            document.body.classList.add('mobile-mode');
        } else {
            document.body.classList.remove('mobile-mode');
        }
        this.resize();
    }

    // Helper to get base procedural for syncing
    getProceduralTile(x, y) {
        if (y < 5) return TILE_TYPES.EMPTY;
        if (y === 5) return TILE_TYPES.GRASS;
        if (y === CONSTANTS.MAP_HEIGHT - 1) return TILE_TYPES.BEDROCK;

        let r = Game.getMapRandom(x, y);
        let type = TILE_TYPES.DIRT;
        if (y > 300) type = TILE_TYPES.DEEP_SLATE;
        else if (y > 100) type = TILE_TYPES.HARD_STONE;
        else if (y > 30) type = TILE_TYPES.STONE;

        if (r > 0.985) {
            if (y > 400) return TILE_TYPES.RUBY;
            else if (y > 250) return TILE_TYPES.EMERALD;
            else if (y > 150) return TILE_TYPES.DIAMOND;
        } else if (r > 0.96) {
            if (y > 100) return TILE_TYPES.GOLD;
        } else if (r > 0.92) {
            if (y > 50) return TILE_TYPES.IRON;
        } else if (r > 0.89) {
            return TILE_TYPES.COAL;
        }
        return type;
    }

    async randomizeUsername() {
        // UI feedback
        const btn = $('start-username').nextElementSibling;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="spin-loader" style="width:12px; height:12px; border-width:2px;"></div>';

        try {
            const res = await fetch('https://randomuser.me/api?inc=login');
            const data = await res.json();
            if (data.results && data.results[0]) {
                let name = data.results[0].login.username;
                // Clean up name slightly if it's too long
                if(name.length > 12) name = name.substring(0, 12);
                $('start-username').value = name;
            } else {
                throw new Error("Invalid API response");
            }
        } catch(e) {
            console.error("API Error, using fallback", e);
            $('start-username').value = 'Miner' + Math.floor(Math.random() * 1000);
        } finally {
             btn.innerHTML = originalText;
        }
    }

    init() {
        this.settings.username = $('start-username').value || 'Miner';
        this.localPlayer.username = this.settings.username;
        // FIX: Trim room ID to ensure seeds match perfectly across clients
        this.settings.room = ($('start-room').value || 'public').trim();
        this.settings.color = $('start-color').value;
        this.settings.broker = $('setting-broker').value;

        // Reset admin on init
        this.isAdmin = false;

        // --- STICKY TIMESTAMP LOGIC ---
        // Restore timestamp for this specific room if it exists
        const timeKey = `mm_joinedAt_${this.settings.room}`;
        const savedTime = localStorage.getItem(timeKey);

        if (savedTime) {
            // Restore previous session time to regain seniority
            this.localPlayer.joinedAt = parseInt(savedTime);
            console.log("Restored session time:", this.localPlayer.joinedAt);
        } else {
            // New session
            this.localPlayer.joinedAt = now();
            localStorage.setItem(timeKey, this.localPlayer.joinedAt);
        }

        localStorage.setItem('mm_username', this.settings.username);
        localStorage.setItem('mm_room_id', this.settings.room);
        localStorage.setItem('mm_veh_color', this.settings.color);
        localStorage.setItem('mm_broker_url', this.settings.broker);

        $('start-screen').style.display = 'none';
        $('connection-screen').style.display = 'flex';
        this.logConnection("Initializing System...");

        this.resize();
        window.addEventListener('resize', () => this.resize());
        window.addEventListener('wheel', (e) => {
            if (e.target.id === 'gameCanvas') {
                this.zoom = clamp(this.zoom - Math.sign(e.deltaY) * 0.1, CONSTANTS.MIN_ZOOM, CONSTANTS.MAX_ZOOM);
            }
        });

        this.minimapCanvas.width = 150;
        this.minimapCanvas.height = 150;

        let seed = 0;
        for (let i = 0; i < this.settings.room.length; i++) seed += this.settings.room.charCodeAt(i);
        this.roomSeed = seed * 12345;

        this.generateMap();
        Input.init();
        Sound.loadSettings();

        // Load stats before connecting
        this.loadLocalProgress();

        Network.connect();
        UI.refreshKeybindLabels();
        UI.checkForUpdates();

        // Start a new session tracking
        if (!SaveSystem.currentSaveId) SaveSystem.currentSaveId = Date.now();
    }

    logConnection(msg) {
        const d = document.createElement('div');
        d.className = 'log-line';
        d.innerText = `> ${msg}`;
        $('connection-log').appendChild(d);
        $('connection-log').scrollTop = $('connection-log').scrollHeight;
    }

    finishConnection() {
        // Critical: Do not re-initialize game state if we just reconnected
        if (this.running) {
            console.log("Reconnected to broker. Game state preserved.");
            $('connection-screen').style.display = 'none';
            // Just broadcast position to sync up
            Network.broadcastMove();
            return;
        }

        setTimeout(async () => {
            $('connection-screen').style.display = 'none';

            this.running = true;
            this.localPlayer.gridX = Math.floor(CONSTANTS.MAP_WIDTH / 2);
            this.localPlayer.gridY = 4;
            this.localPlayer.x = this.localPlayer.gridX * CONSTANTS.TILE_SIZE;
            this.localPlayer.y = this.localPlayer.gridY * CONSTANTS.TILE_SIZE;
            this.localPlayer.stats.startTime = now();
            Sound.init();

            // Initial Host Check: If I'm alone, I am Admin.
            if (Object.keys(this.remotePlayers).length === 0) {
                this.isAdmin = true;
                this.hostId = this.localPlayer.id;
                this.lastHostHeartbeat = Date.now();
                UI.showToast("Room Created. You are Admin.", "success");
                UI.updateAdminPanel();
            } else {
                // If others exist, wait for heartbeat.
                // If no heartbeat comes in loop(), checkHostHealth() will elect me if I'm oldest.
                this.isAdmin = false;
                UI.updateAdminPanel();
            }

            // ONLY load save if we are the host (Admin)
            if (this.isAdmin) {
                const lastId = localStorage.getItem('mm_last_save_id');
                if (lastId) {
                    console.log("Host detected, loading save:", lastId);
                    await SaveSystem.loadGame(parseInt(lastId), true);
                    UI.addMessage("System", "Auto-loaded previous save.", "#2ecc71");
                }
            } else {
                // If we are NOT admin (Client), ensure we rely on the procedural map + sync
                // We do NOT load any local saves to prevent overwriting the host's world
                Network.requestMap(null); // Request from host (broadcast if id is null or not found, see handler)
                UI.addMessage("System", "Waiting for Map Sync...", "#3498db");
            }

            this.loop();
            UI.addMessage("System", "Welcome. E for Menu/Shop. B to Build. F to Transfer.", "#FFFF00");
            Network.broadcastMove();
            // Removed updateAdminStatus call
        }, 1000);
    }

    resize() {
        if (this.isMobile) {
            if (window.innerWidth > window.innerHeight) {
                // Landscape: 200px buffer on each side (400px total)
                this.canvas.width = window.innerWidth - 400;
                this.canvas.height = window.innerHeight;
            } else {
                // Portrait: Bottom bar
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight - 180; // 180px for controls
            }
        } else {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
        }
    }

    generateMap() {
        for (let y = 0; y < CONSTANTS.MAP_HEIGHT; y++) {
            this.map[y] = [];
            this.discovered[y] = new Uint8Array(CONSTANTS.MAP_WIDTH);
            for (let x = 0; x < CONSTANTS.MAP_WIDTH; x++) {
                if (y < 5) {
                    this.map[y][x] = TILE_TYPES.EMPTY;
                    this.discovered[y][x] = 1;
                }
                else if (y === 5) {
                     this.map[y][x] = TILE_TYPES.GRASS;
                     this.discovered[y][x] = 1;
                }
                else if (y === CONSTANTS.MAP_HEIGHT - 1) this.map[y][x] = TILE_TYPES.BEDROCK;
                else {
                    this.map[y][x] = this.getProceduralTile(x,y);
                }
            }
        }
    }

    getMapRandom(x, y) {
        const s = Math.sin(x * 12.9898 + y * 78.233 + this.roomSeed) * 43758.5453;
        return s - Math.floor(s);
    }

    toggleCoords(show) {
        $('coords-display').style.display = show ? 'block' : 'none';
        localStorage.setItem('mm_show_coords', show);
    }

    update() {
        if (!this.running) return;
        const p = this.localPlayer;
        const TS = CONSTANTS.TILE_SIZE;

        let targetX = p.gridX * TS;
        let targetY = p.gridY * TS;
        let dx = targetX - p.x;
        let dy = targetY - p.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        let speed = this.localPlayer.fuel > 0 ? (this.localPlayer.isDrilling ? CONSTANTS.SPEED_DRILL : CONSTANTS.SPEED_NORMAL) : 0.3;
        let isMoving = false;

        if (dist > speed) {
            let angle = Math.atan2(dy, dx);
            p.x += Math.cos(angle) * speed; p.y += Math.sin(angle) * speed;
            isMoving = true;
        } else {
            p.x = targetX; p.y = targetY; p.isDrilling = false;
            let ix = 0, iy = 0;
            // Input combining Keys + Virtual
            if (Input.keys[this.settings.keys.up] || Input.virtual.up) iy = -1;
            else if (Input.keys[this.settings.keys.down] || Input.virtual.down) iy = 1;
            else if (Input.keys[this.settings.keys.left] || Input.virtual.left) ix = -1;
            else if (Input.keys[this.settings.keys.right] || Input.virtual.right) ix = 1;

            // Build logic
            const buildPressed = Input.keys[this.settings.keys.build] || Input.virtual.build;

            if (buildPressed && (ix || iy)) {
                if (now() - this.lastActionTime > 200) {
                    this.tryBuild(p.gridX + ix, p.gridY + iy);
                    this.lastActionTime = now();
                }
            } else if (ix || iy) {
                if (ix === 1) p.rotation = -90 * (Math.PI/180);
                if (ix === -1) p.rotation = 90 * (Math.PI/180);
                if (iy === 1) p.rotation = 0;
                if (iy === -1) p.rotation = 180 * (Math.PI/180);

                let nx = p.gridX + ix;
                let ny = p.gridY + iy;
                if (nx >= 0 && nx < CONSTANTS.MAP_WIDTH && ny >= 4 && ny < CONSTANTS.MAP_HEIGHT) {
                    let tile = (ny < 0) ? TILE_TYPES.EMPTY : this.map[ny][nx];

                    // --- TELEPORTER LOGIC (Instant Travel) ---
                    if (tile === TILE_TYPES.TELEPORTER) {
                        $('prompt-msg').style.display = 'block';
                        $('prompt-msg').innerText = "PRESS E TO WARP";

                        // Check if we discovered this?
                        const known = p.teleporters.find(t => t.x === nx && t.y === ny);
                        if(!known) {
                            p.teleporters.push({ x: nx, y: ny, name: `Discovered Relay [${nx},${ny}]` });
                            UI.showToast("New Teleporter Discovered!", "success");
                            this.saveLocalProgress();
                        }
                    }

                    if (tile === TILE_TYPES.EMPTY || tile === TILE_TYPES.TELEPORTER) {
                        p.gridX = nx; p.gridY = ny;
                        if (p.gridY > 5 && p.fuel > 0) p.fuel -= CONSTANTS.FUEL_CONSUMPTION;
                        Network.broadcastMove();
                    } else if (tile !== TILE_TYPES.BEDROCK) {
                        if (now() - this.lastActionTime > 150) {
                            if (this.tryMine(nx, ny)) {
                                p.gridX = nx; p.gridY = ny;
                                p.isDrilling = true;
                                if (p.gridY > 5 && p.fuel > 0) p.fuel -= CONSTANTS.FUEL_CONSUMPTION;
                                Network.broadcastMove();
                            }
                            this.lastActionTime = now();
                        }
                    }
                }
            }
        }

        // Explosive Logic (Host Only)
        if (this.isAdmin && this.explosives.length > 0) {
            for (let i = this.explosives.length - 1; i >= 0; i--) {
                let e = this.explosives[i];
                e.timer--;
                if (e.timer <= 0) {
                    // BOOM
                    Network.broadcastExplosion(e.x, e.y, e.range);
                    this.explosives.splice(i, 1);
                }
            }
        }

        Sound.updateEngine(isMoving ? speed : 0, p.isDrilling);

        // Remote Interpolation
        Object.values(this.remotePlayers).forEach(rp => {
            if (rp.targetX !== undefined) {
                let rdx = rp.targetX - rp.x; let rdy = rp.targetY - rp.y;
                let rDist = Math.sqrt(rdx*rdx + rdy*rdy);
                let rSpeed = rp.isDrilling ? CONSTANTS.SPEED_DRILL : CONSTANTS.SPEED_NORMAL;
                if (rDist > rSpeed) {
                    let rAngle = Math.atan2(rdy, rdx);
                    rp.x += Math.cos(rAngle) * rSpeed; rp.y += Math.sin(rAngle) * rSpeed;
                } else { rp.x = rp.targetX; rp.y = rp.targetY; }
            }
        });

        // Heat & Prompt
        let depth = Math.max(0, p.gridY - 5);
        let heatThreshold = 100 + (p.heatResist * 50);
        if (depth > heatThreshold) {
            p.temp += 0.05;
            if (p.temp > 100) { p.temp = 100; p.hull -= 0.1; $('heat-overlay').style.opacity = (Math.sin(now()/100)+1)/4 + 0.3; }
        } else { p.temp = Math.max(0, p.temp - 0.2); $('heat-overlay').style.opacity = 0; }

        $('prompt-msg').style.display = 'none';

        // Check Teleporter interaction
        if (this.map[p.gridY][p.gridX] === TILE_TYPES.TELEPORTER) {
             $('prompt-msg').style.display = 'block';
             $('prompt-msg').innerText = "PRESS E TO WARP";
        }

        if (p.gridY === this.stationGridY && Math.abs(p.gridX - this.stationGridX) < 3) {
             $('prompt-msg').style.display = 'block';
             $('prompt-msg').innerText = "PRESS E TO OPEN DASHBOARD/SHOP";
        }

        const interactPressed = Input.keys[this.settings.keys.interact] || Input.virtual.interact;
        if (interactPressed && now() - this.lastActionTime > 500) {
            // Priority: Teleporter -> Station -> Dashboard
            if (this.map[p.gridY][p.gridX] === TILE_TYPES.TELEPORTER) {
                UI.openWarpMenu();
            } else {
                UI.toggleDashboard();
            }
            this.lastActionTime = now();
            Input.virtual.interact = false; // consume
        }

        // Transfer Check
        const transferPressed = Input.keys[this.settings.keys.transfer] || Input.virtual.transfer;
        if (transferPressed && now() - this.lastActionTime > 1000) {
            // Find nearest player
            let nearest = null;
            let minDst = 100; // range
            Object.values(this.remotePlayers).forEach(rp => {
                let d = Math.sqrt((rp.x - p.x)**2 + (rp.y - p.y)**2);
                if(d < minDst) { minDst = d; nearest = rp; }
            });

            if(nearest) {
                this.tryTransferFuel(nearest.id);
            } else {
                UI.showToast("No one nearby to transfer to!", "error");
            }
            this.lastActionTime = now();
            Input.virtual.transfer = false;
        }

        // Mobile Action consumption
        if (Input.virtual.chat && now() - this.lastActionTime > 200) {
            $('chat-input').focus();
            Input.virtual.chat = false;
        }

        p.fuel = clamp(p.fuel, 0, p.maxFuel); p.hull = clamp(p.hull, 0, p.maxHull);
        if (p.hull <= 0) this.respawn();

        this.camera.x += (p.x - this.camera.x) * 0.1;
        this.camera.y += (p.y - this.camera.y) * 0.1;

        if (now() % 5000 < 20) this.saveLocalProgress();
        if (SaveSystem.autosaveEnabled && now() - this.lastAutosave > 60000 && Game.isAdmin && SaveSystem.currentSaveId) {
            SaveSystem.saveGame(SaveSystem.currentSaveId, null, true); this.lastAutosave = now();
        }

        Network.update();
        this.checkHostHealth();

        if (this.lastCoordsX !== p.gridX || this.lastCoordsY !== p.gridY) {
            $('coords-display').innerText = `X: ${p.gridX} Y: ${depth}`;
            this.lastCoordsX = p.gridX; this.lastCoordsY = p.gridY;
        }
    }

    tryTransferFuel(targetId) {
        if (this.localPlayer.fuel > 10) {
            this.localPlayer.fuel -= 10;
            Network.sendFuel(targetId, 10);
            UI.showToast("Sent 10 Fuel!", "success");
            Sound.playSuccess();
        } else {
            UI.showToast("Not enough fuel!", "error");
            Sound.playError();
        }
    }

    tryBuild(tx, ty) {
        if (tx < 0 || tx >= CONSTANTS.MAP_WIDTH || ty < 4 || ty >= CONSTANTS.MAP_HEIGHT) return;
        if (this.map[ty][tx] === TILE_TYPES.EMPTY) {
            const type = this.localPlayer.selectedBlock;
            let count = this.localPlayer.inventory[type] || 0;

            if (count > 0) {
                // If placing a Teleporter, name it!
                if(type === TILE_TYPES.TELEPORTER) {
                    const name = prompt("Name this Teleporter:", `Relay ${tx}-${ty}`);
                    if(!name) return; // Cancel build if canceled

                    this.localPlayer.teleporters.push({
                        x: tx, y: ty, name: name || `Relay ${tx}-${ty}`
                    });
                    this.saveLocalProgress();
                }

                this.localPlayer.inventory[type]--;
                this.localPlayer.cargo--;
                this.map[ty][tx] = type;
                Network.sendTileUpdate(tx, ty, type);
                this.spawnParticle(tx * 32 + 16, ty * 32 + 16, '#95a5a6', 5);
                Sound.playBuild();
                // Host logic: Register explosive timer
                if (this.isAdmin) {
                    if (type === TILE_TYPES.TNT) this.explosives.push({x:tx, y:ty, range:3, timer: 120}); // 2s
                    if (type === TILE_TYPES.NUKE) this.explosives.push({x:tx, y:ty, range:10, timer: 300}); // 5s
                }
                UI.showToast("Block Placed", "success");
                UI.updateDashboard();
            } else {
                UI.showToast("Out of blocks!", "error");
                Sound.playError();
            }
        }
    }

    // --- EXPLOSION ---
    explode(cx, cy, radius) {
        Sound.playExplosion();
        // Shake camera
        const shake = setInterval(() => {
            this.camera.x += (Math.random()-0.5)*10;
            this.camera.y += (Math.random()-0.5)*10;
        }, 20);
        setTimeout(() => clearInterval(shake), 300);

        for (let y = cy - radius; y <= cy + radius; y++) {
            for (let x = cx - radius; x <= cx + radius; x++) {
                if (y > 4 && x >= 0 && x < CONSTANTS.MAP_WIDTH && y < CONSTANTS.MAP_HEIGHT) {
                    if (Math.sqrt((x-cx)**2 + (y-cy)**2) <= radius) {
                        if (this.map[y][x] !== TILE_TYPES.BEDROCK) {
                            this.map[y][x] = TILE_TYPES.EMPTY;
                            this.discovered[y][x] = 1; // Reveal area
                            this.spawnParticle(x*32+16, y*32+16, '#ffaa00', 3);
                        }
                    }
                }
            }
        }

        // Damage players
        const p = this.localPlayer;
        if (Math.abs(p.gridX - cx) < radius && Math.abs(p.gridY - cy) < radius) {
            p.hull -= 50;
            UI.showToast("CAUGHT IN EXPLOSION!", "error");
        }
    }

    trashBlock(type, all=false) {
        const p = this.localPlayer;
        if(p.inventory[type] > 0) {
            let amount = all ? p.inventory[type] : 1;
            p.inventory[type] -= amount;
            p.cargo -= amount;

            if(p.inventory[type] < 0) p.inventory[type] = 0; // sanity
            if(p.cargo < 0) p.cargo = 0;

            const name = TILE_PROPS[type].name;
            UI.showToast(`Trashed ${amount} ${name}`, "normal");
            UI.updateDashboard();
        }
    }

    trashJunk() {
        const p = this.localPlayer;
        let totalTrashed = 0;

        for (let key in p.inventory) {
            let type = parseInt(key);
            let count = p.inventory[type];
            let prop = TILE_PROPS[type];

            // Trash if value is 0, but keep Casings AND Shop Items
            if (count > 0 && prop.value === 0 && type !== TILE_TYPES.CASING && !SHOP_ITEMS.includes(type)) {
                p.inventory[type] = 0;
                p.cargo -= count;
                totalTrashed += count;
            }
        }

        if (p.cargo < 0) p.cargo = 0;

        if(totalTrashed > 0) {
            UI.showToast(`Trashed ${totalTrashed} Junk Items`, "success");
            Sound.playChat('death'); // Reuse sound for impact
        } else {
            UI.showToast("No Junk Found", "normal");
        }
        UI.updateDashboard();
    }

    tryMine(tx, ty) {
        let tile = this.map[ty][tx];
        if (tile !== TILE_TYPES.EMPTY && tile !== TILE_TYPES.BEDROCK && this.localPlayer.fuel > 0) {
            let props = TILE_PROPS[tile];
            if (this.localPlayer.drillTier < props.tier) { UI.showToast(`Need Tier ${props.tier} Drill`, "error"); Sound.playError(); return false; }
            if (this.localPlayer.cargo < this.localPlayer.maxCargo) {
                if (!this.localPlayer.inventory[tile]) this.localPlayer.inventory[tile] = 0;
                this.localPlayer.inventory[tile]++;
                this.localPlayer.cargo++;

                if (!this.localPlayer.stats.blocksMined[tile]) this.localPlayer.stats.blocksMined[tile] = 0;
                this.localPlayer.stats.blocksMined[tile]++;
                this.localPlayer.stats.totalMined++;

                this.map[ty][tx] = TILE_TYPES.EMPTY;
                this.discovered[ty][tx] = 1;
                this.spawnParticle(tx * 32 + 16, ty * 32 + 16, props.color, 8);
                Sound.playMining();
                Network.sendTileUpdate(tx, ty, TILE_TYPES.EMPTY);
                UI.updateDashboard();
                return true;
            } else { UI.showToast("Cargo Full!", "error"); Sound.playError(); return false; }
        }
        return false;
    }

    spawnParticle(x, y, color, count) {
        for(let i=0; i<count; i++) {
            this.particles.push({x, y, vx: (Math.random()-0.5)*6, vy: (Math.random()-0.5)*6, life: 1.0, color});
        }
    }

    respawn() {
        this.localPlayer.gridX = Math.floor(CONSTANTS.MAP_WIDTH / 2);
        this.localPlayer.gridY = 4;
        this.localPlayer.x = this.localPlayer.gridX * CONSTANTS.TILE_SIZE;
        this.localPlayer.y = this.localPlayer.gridY * CONSTANTS.TILE_SIZE;
        this.localPlayer.hull = this.localPlayer.maxHull;
        this.localPlayer.fuel = this.localPlayer.maxFuel;
        this.localPlayer.cargo = 0;
        this.localPlayer.inventory = {};
        this.localPlayer.money = Math.floor(this.localPlayer.money * 0.7);
        Network.broadcastDeath();
        Sound.playChat('death');
        $('heat-overlay').style.opacity = 0;
        UI.updateDashboard();
    }

    draw() {
        if (!this.running) return;
        this.ctx.resetTransform();
        this.ctx.fillStyle = '#050505';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        let cx = this.canvas.width / 2;
        let cy = this.canvas.height / 2;
        this.ctx.translate(cx, cy);
        this.ctx.scale(this.zoom, this.zoom);
        this.ctx.translate(-Math.floor(this.camera.x), -Math.floor(this.camera.y));

        const viewW = (this.canvas.width / this.zoom);
        const viewH = (this.canvas.height / this.zoom);
        const startCol = Math.floor((this.camera.x - viewW/2) / CONSTANTS.TILE_SIZE) - 1;
        const endCol = Math.floor((this.camera.x + viewW/2) / CONSTANTS.TILE_SIZE) + 1;
        const startRow = Math.floor((this.camera.y - viewH/2) / CONSTANTS.TILE_SIZE) - 1;
        const endRow = Math.floor((this.camera.y + viewH/2) / CONSTANTS.TILE_SIZE) + 1;

        const pcx = this.localPlayer.gridX;
        const pcy = this.localPlayer.gridY;
        const visionRad = this.localPlayer.xrayRange;

        /// -------------------------------
        // WORLD TIME (host-based)
        // -------------------------------
        const allPlayers = Object.values(this.remotePlayers)
            .concat([this.localPlayer])
            .filter(p => typeof p.joinedAt === "number" && !isNaN(p.joinedAt));
        if (allPlayers.length === 0) {
            // fallback: treat local player as host
            allPlayers.push({ ...this.localPlayer, joinedAt: Date.now() });
        }
        const host = allPlayers.sort((a,b)=>a.joinedAt - b.joinedAt)[0] || this.localPlayer;
        const worldTime = Date.now() - host.joinedAt;

        const dayLength = 20 * 60 * 1000;
        const t = (worldTime % dayLength) / dayLength;

        // Rotate so sunrise = 0.25, noon = 0.5, sunset = 0.75
        const sunAngle = (t * Math.PI * 2) - Math.PI / 2;

        // Smooth daylight curve (no flicker)
        const daylight = (() => {
            const x = (Math.cos(sunAngle) + 1) / 2; // 010
            return x * x * (3 - 2 * x);            // smoothstep
        })();

        // -------------------------------
        // SKY COLOR (above ground level y=5)
        // -------------------------------
        const baseSky = { r: 135, g: 206, b: 235 };
        const groundY = 5 * CONSTANTS.TILE_SIZE;

        const sunrise = Math.max(0, 1 - Math.abs(t - 0.25) * 20);
        const sunset  = Math.max(0, 1 - Math.abs(t - 0.75) * 20);
        const warm = sunrise + sunset;

        const r = Math.round(baseSky.r * (0.3 + daylight*0.7) - warm * 80);
        const g = Math.round(baseSky.g * (0.3 + daylight*0.7) - warm * 40);
        const b = Math.round(baseSky.b * (0.3 + daylight*0.7) - warm * 20);

        this.ctx.fillStyle = `rgb(${r},${g},${b})`;
        this.ctx.fillRect(
            this.camera.x - viewW,
            -2000,
            viewW * 2,
            groundY + 2000
        );

        // Sunrise/sunset gradient
        if (warm > 0) {
            const grad = this.ctx.createLinearGradient(0, -2000, 0, groundY);
            grad.addColorStop(0, `rgba(255,120,50,${warm * 0.6})`);
            grad.addColorStop(1, `rgba(255,180,120,${warm * 0.3})`);
            this.ctx.fillStyle = grad;
            this.ctx.fillRect(
                this.camera.x - viewW,
                -2000,
                viewW * 2,
                groundY + 2000
            );
        }

        // -------------------------------
        // SUN & MOON POSITIONS
        // -------------------------------
        const skyRadius = 900;
        const centerX = this.camera.x;
        // Fix: Pivot exactly at ground level so sunrise/sunset looks correct
        const centerY = groundY;

        const sunX = centerX + Math.cos(sunAngle) * skyRadius;
        const sunY = centerY + Math.sin(sunAngle) * skyRadius;

        const moonX = centerX + Math.cos(sunAngle + Math.PI) * skyRadius;
        const moonY = centerY + Math.sin(sunAngle + Math.PI) * skyRadius;

        // -------------------------------
        // SUN (always drawn)
        // -------------------------------
        {
            const sunSize = 70;
            const grd = this.ctx.createRadialGradient(sunX, sunY, 0, sunX, sunY, sunSize);
            grd.addColorStop(0, "rgba(255,255,200,1)");
            grd.addColorStop(1, "rgba(255,180,0,0.2)");

            this.ctx.fillStyle = grd;
            this.ctx.beginPath();
            this.ctx.arc(sunX, sunY, sunSize, 0, Math.PI*2);
            this.ctx.fill();
        }

        // -------------------------------
        // MOON (one draw call, 3 phases)
        // -------------------------------
        {
            const moonSize = 55;
            const moonCycle = 60 * 60 * 1000;
            const moonPhase = (worldTime % moonCycle) / moonCycle; // 0=new, 0.5=full

            this.ctx.fillStyle = "#e0e0e0";
            this.ctx.beginPath();

            // Outer circle
            this.ctx.arc(moonX, moonY, moonSize, 0, Math.PI * 2);

            // Phase curve (one quadratic curve)
            const curveOffset = (moonPhase - 0.5) * moonSize * 1.6;

            this.ctx.moveTo(moonX - moonSize, moonY);
            this.ctx.quadraticCurveTo(
                moonX + curveOffset,
                moonY,
                moonX - moonSize,
                moonY
            );

            this.ctx.fill();
        }

        // -------------------------------
        // STARS
        // -------------------------------
        if (!this.starField) {
            this.starField = [];
            for (let i = 0; i < 200; i++) {
                this.starField.push({
                    x: Math.random() * 5000 - 2500,
                    y: Math.random() * 2000 - 2000,
                    b: Math.random() * 0.8 + 0.2
                });
            }
        }

        {
            const starAlpha = (0.4 - daylight) / 0.4;
            if (starAlpha > 0) {
                this.ctx.fillStyle = "#fff";
                for (const s of this.starField) {
                    this.ctx.globalAlpha = s.b * starAlpha;
                    this.ctx.fillRect(s.x, s.y, 2, 2);
                }
                this.ctx.globalAlpha = 1;
            }
        }

        // -------------------------------
        // BLACK RECTANGLE (drawn LAST in sky section)
        // -------------------------------
        this.ctx.fillStyle = "#000";
        this.ctx.fillRect(
            this.camera.x - viewW,
            groundY,
            viewW * 2,
            5000
        );

        this.drawStation();

        for (let y = Math.max(0, startRow); y <= Math.min(CONSTANTS.MAP_HEIGHT-1, endRow); y++) {
            for (let x = Math.max(0, startCol); x <= Math.min(CONSTANTS.MAP_WIDTH-1, endCol); x++) {
                let dx = x - pcx; let dy = y - pcy;
                let dist = Math.sqrt(dx*dx + dy*dy);
                let visible = dist <= visionRad;
                if (dist <= this.localPlayer.xrayRange) this.discovered[y][x] = 1;
                let tile = this.map[y][x];

                if (visible) this.drawProceduralTile(x, y, tile, !visible);
                else if (this.discovered[y][x]) {
                    this.ctx.globalAlpha = 0.9;
                    this.drawProceduralTile(x, y, tile, false);
                    this.ctx.globalAlpha = 1.0;
                }
            }
        }

        Object.values(this.remotePlayers).forEach(p => this.drawPlayer(p, false));
        this.drawPlayer(this.localPlayer, true);

        for (let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i];
            p.x += p.vx; p.y += p.vy; p.life -= 0.05;
            this.ctx.globalAlpha = p.life; this.ctx.fillStyle = p.color;
            this.ctx.fillRect(p.x, p.y, 4, 4); this.ctx.globalAlpha = 1.0;
            if (p.life <= 0) this.particles.splice(i, 1);
        }

        this.drawLocalMinimap();
        this.ctx.resetTransform();
        this.drawHUD();
    }


    drawStation() {
        const ts = CONSTANTS.TILE_SIZE;

        // Station top-left corner in pixels
        const baseX = (this.stationGridX * ts)+ts;
        const baseY = (this.stationGridY * ts)-ts;

        const ctx = this.ctx;

        // -------------------------------
        // BUILDING DIMENSIONS (in tiles)
        // -------------------------------
        const buildingW = 2 * ts;   // 2 tiles wide
        const buildingH = 2 * ts;   // 2 tiles tall

        const roofH = ts * 0.4;     // roof height
        const doorW = ts * 0.5;
        const doorH = ts * 0.9;

        // -------------------------------
        // MAIN BUILDING
        // -------------------------------
        ctx.fillStyle = "#7f8c8d"; // concrete walls
        ctx.fillRect(baseX, baseY, buildingW, buildingH);

        // Wall bevel
        ctx.fillStyle = "rgba(0,0,0,0.25)";
        ctx.fillRect(baseX, baseY + buildingH - 4, buildingW, 4);
        ctx.fillRect(baseX + buildingW - 4, baseY, 4, buildingH);

        ctx.fillStyle = "rgba(255,255,255,0.15)";
        ctx.fillRect(baseX, baseY, buildingW, 3);
        ctx.fillRect(baseX, baseY, 3, buildingH);

        // -------------------------------
        // ROOF (tile-aligned)
        // -------------------------------
        ctx.fillStyle = "#c0392b";
        ctx.fillRect(baseX - ts * 0.25, baseY - roofH, buildingW + ts * 0.5, roofH);

        // Roof trim
        ctx.fillStyle = "#922b21";
        ctx.fillRect(baseX - ts * 0.25, baseY - roofH, buildingW + ts * 0.5, 4);

        // -------------------------------
        // DOOR (centered)
        // -------------------------------
        const doorX = baseX + buildingW / 2 - doorW / 2;
        const doorY = baseY + buildingH - doorH;

        ctx.fillStyle = "#2c3e50";
        ctx.fillRect(doorX, doorY, doorW, doorH);

        // Door handle
        ctx.fillStyle = "#ecf0f1";
        ctx.fillRect(doorX + doorW - 8, doorY + doorH / 2, 6, 2);

        // -------------------------------
        // WINDOWS
        // -------------------------------
        const winW = ts * 0.7;
        const winH = ts * 0.6;

        ctx.fillStyle = "#3498db";

        // Left window
        ctx.fillRect(baseX + ts * 0.2, baseY + ts * 0.3, winW, winH);

        // Right window
        ctx.fillRect(baseX + buildingW - winW - ts * 0.2, baseY + ts * 0.3, winW, winH);

        // Window shine
        ctx.fillStyle = "rgba(255,255,255,0.25)";
        ctx.fillRect(baseX + ts * 0.25, baseY + ts * 0.35, winW * 0.4, winH * 0.2);
        ctx.fillRect(baseX + buildingW - winW - ts * 0.15, baseY + ts * 0.35, winW * 0.4, winH * 0.2);

        // -------------------------------
        // SIGNAGE
        // -------------------------------
        ctx.fillStyle = `hsl(${(Date.now()*0.05)%360}, 100%, 60%)`;
        ctx.font = `${ts * 0.5}px Arial`;
        ctx.textAlign = "center";
        ctx.fillText("SHOP", baseX + buildingW / 2, baseY - roofH * 0.4);

        // -------------------------------
        // GAS PUMPS (tile-aligned, left side)
        // -------------------------------
        const pumpW = ts * 0.5;
        const pumpH = ts * 1.2;

        // Pumps should sit to the LEFT of the building
        const pumpX = baseX - ts*2;   // 1.2 tiles left of building
        const pumpY = baseY + buildingH - pumpH;  // same Y-level for both pumps


        // Pump hoses
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 3;

        ctx.beginPath();
        ctx.moveTo(pumpX + pumpW, pumpY - ts * 0.3 + pumpH * 0.6);
        ctx.lineTo(pumpX + pumpW + ts * 0.3, pumpY - ts * 0.3 + pumpH * 0.8);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(pumpX + pumpW - ts, pumpY - ts * 0.3 + pumpH * 0.6);
        ctx.lineTo(pumpX + pumpW + ts * 0.3 - ts, pumpY - ts * 0.3 + pumpH * 0.8);
        ctx.stroke();

        ctx.fillStyle = "#bdc3c7";

        // Pump 1 (front)
        ctx.fillRect(pumpX, pumpY, pumpW, pumpH);

        // Pump 2 (behind it, slightly offset upward)
        ctx.fillRect(pumpX - ts, pumpY, pumpW, pumpH);

        // Pump screens
        ctx.fillStyle = "#2c3e50";
        ctx.fillRect(pumpX + pumpW * 0.2, pumpY + ts * 0.2, pumpW * 0.6, pumpH * 0.3);
        ctx.fillRect(pumpX + pumpW * 0.2 - ts, pumpY + ts * 0.2, pumpW * 0.6, pumpH * 0.3);
    }


    drawProceduralTile(x, y, type) {
        let ts = CONSTANTS.TILE_SIZE;
        let px = x * ts; let py = y * ts;
        let prop = TILE_PROPS[type];

        // Detailed Texture Patterns

        const n1 = (pseudoRandom(x, y) % 1);
        const n2 = ((pseudoRandom(x, y) * 10) % 1);

        let bevel = true;
        let isOre = false;

        // --- ORE RENDERING (Detailed) ---
        if (type >= TILE_TYPES.COAL && type <= TILE_TYPES.RUBY) {
        isOre=true
            // Stone background
            this.ctx.fillStyle = TILE_PROPS[TILE_TYPES.STONE].color;
            this.ctx.fillRect(px, py, ts, ts);


            // Ore color
            this.ctx.fillStyle = prop.color;

            // Use your seeded RNG
            const r0 = pseudoRandom(x, y);
            const r1 = pseudoRandom(x + 17, y + 3);
            const r2 = pseudoRandom(x - 9, y + 11);
            const r3 = pseudoRandom(x + 4, y -
